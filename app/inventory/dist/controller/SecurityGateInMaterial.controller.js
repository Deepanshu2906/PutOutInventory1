sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(e,t,a,o){"use strict";let n=0;return e.extend("inventory.controller.SecurityGateInMaterial",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.getRoute("RouteGateMaterial").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:async function(){try{this.resetTableControls();const e=JSON.parse(sessionStorage.getItem("materialData"));const t=e?e.reqNo:null;console.log("status hai",e.reqStatus);if(e.reqStatus==="Closed"){this.layoutEditOnStatus()}let o=this.getOwnerComponent().getModel();let n=o.bindList("/rqMaterial",undefined,undefined,undefined,{$expand:"SubcomponentList"});let s=await n.requestContexts(0,Infinity);let i=s.map(e=>e.getObject());let r=i.filter(e=>e.reqNo===t);console.log("Bid details data:",r);let l=new a(r);this.getView().setModel(l,"materialData");console.log("model data is",this.getView().getModel("materialData").getData());let d=this.byId("materialTable");d.attachEventOnce("updateFinished",this.resetTableControls.bind(this))}catch(e){}},layoutEditOnStatus:function(){let e=this.getView().byId("materialDetailsLayout2");let t=this.getView().byId("materialDetailsLayout");e.setVisible(true);t.setVisible(false);if(!n){n=1}},resetTableControls:function(){let e=this.byId("materialTable");e.getItems().forEach(function(e){let t=e.getCells();let a=t[5];if(a instanceof sap.m.Select){a.setSelectedKey("")}let o=t[4];if(o instanceof sap.m.Input){o.setEditable(false)}let n=t[7];if(n instanceof sap.m.Button){n.setEnabled(false)}let s=t[6];if(s instanceof sap.m.Input){s.setValue("")}})},onMaterialRowSelect:async function(e){const a=this.getView();let o=e.getSource().getParent().getBindingContext("materialData");let s=o.getObject();let i=s.SubcomponentList||[];if(!this.expandCheckinDataFragment){t.load({id:a.getId(),name:"inventory.fragments.GateInSubMaterial",controller:this}).then(e=>{this.expandCheckinDataFragment=e;a.addDependent(this.expandCheckinDataFragment);let o=new sap.ui.model.json.JSONModel(i);this.expandCheckinDataFragment.setModel(o,"subMaterialData");if(n){let e=t.byId(this.getView().getId(),"expandSubTable");e.getItems().forEach(e=>{let t=e.getCells()[3];if(t){t.setEditable(false)}})}this.expandCheckinDataFragment.open()}).catch(e=>{console.error("Failed to load fragment:",e)})}else{let e=new sap.ui.model.json.JSONModel(i);this.expandCheckinDataFragment.setModel(e,"subMaterialData");if(n){let e=t.byId(this.getView().getId(),"expandSubTable");e.getItems().forEach(e=>{let t=e.getCells()[3];if(t){t.setEditable(false)}})}this.expandCheckinDataFragment.open()}},_onStatusTypeChange:function(e){let t=e.getParameter("selectedItem");let a=t.getKey();var o=e.getSource();var n=o.getSelectedItem().getText();let s=e.getSource().getBindingContext("materialData");s.setProperty("MatStatus",a);console.log("selected item",n);let i=o.getParent();let r=i.getCells()[4];let l=i.getCells()[7];if(n==="Partial"){if(r instanceof sap.m.Input){r.setEditable(true)}if(l instanceof sap.m.Button){l.setEnabled(true)}}else{if(r instanceof sap.m.Input){r.setEditable(false)}if(l instanceof sap.m.Button){l.setEnabled(false)}}},_onCancelCheckinSubFragment:function(){this.expandCheckinDataFragment.close()},_onMaterialSubmit:async function(){debugger;let e=this.byId("materialTable");let t=e.getItems();let a=[];t.forEach(function(e){let t=e.getBindingContext("materialData");let o=t.getProperty("SubcomponentList");let n={reqNo:t.getProperty("reqNo"),MaterialCode:t.getProperty("MaterialCode"),Category:t.getProperty("Category"),Description:t.getProperty("Description"),Quantity:t.getProperty("Quantity"),Remarks:t.getProperty("Remarks"),Status:t.getProperty("Status"),SubcomponentList:o};a.push(n)});console.log("updated data of all",a);this._submitData(a)},_submitData:async function(e){debugger;let t=this.getView().getModel();const a=JSON.parse(sessionStorage.getItem("materialData"));const o=a?a.reqNo:null;let n=t.bindList("/serviceRequest");let s=[new sap.ui.model.Filter("reqNo",sap.ui.model.FilterOperator.EQ,o)];try{let a=await n.filter(s).requestContexts();if(a.length>0){let o=a[0];o.setProperty("reqStatus","Closed");let n=o.getModel().bindList("Materials",o);let s=await n.requestContexts();for(let t of e){let e=s.find(e=>e.getProperty("MaterialCode")===t.MaterialCode);if(e){e.setProperty("Category",t.Category);e.setProperty("Description",t.Description);e.setProperty("Quantity",t.Quantity);e.setProperty("MatRemarks",t.Remarks);e.setProperty("MatStatus",t.Status);if(t.SubcomponentList&&t.SubcomponentList.length>0){let a=e.getModel().bindList("SubcomponentList",e);let o=await a.requestContexts();for(let e of t.SubcomponentList){let t=o.find(t=>t.getProperty("MaterialCode")===e.MaterialCode);if(t){t.setProperty("Category",e.Category);t.setProperty("Description",e.Description);t.setProperty("Quantity",e.Quantity)}else{console.error("No sub-material found for MaterialCode: "+e.MaterialCode)}}}}else{console.error("No material found for MaterialCode: "+t.MaterialCode)}}if(t.hasPendingChanges()){await t.submitBatch("updateGroup");sap.m.MessageToast.show("All materials and sub-materials updated successfully.");setTimeout(()=>{const e=this.getOwnerComponent().getRouter();e.navTo("RouteWarehouseMain")},1e3)}else{console.log("No pending changes detected")}}else{console.error("Service request not found for reqNo: "+o)}}catch(e){console.error("Error updating materials and sub-materials:",e);sap.m.MessageToast.show("Error updating materials: "+e.message)}}})});
//# sourceMappingURL=SecurityGateInMaterial.controller.js.map